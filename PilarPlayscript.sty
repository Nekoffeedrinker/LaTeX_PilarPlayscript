\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{PilarPlayscript}[2025/10/13 Paquete para textos teatrales]

%-----------------------------------------------------------
%    Variables del paquete
%-----------------------------------------------------------

\RequirePackage{kvoptions}

\SetupKeyvalOptions{
	family=pilarteatro,
	prefix=pilarteatro@
}

%-----------------------------
%   Activar opciones

\DeclareBoolOption{verso}
\DeclareBoolOption{multicol}


%-----------------------------
%   Definir longitudes

% Sangría del texto del parlamento
\DeclareStringOption[10mm]{sepHablaL}  % valor por defecto: 10pt
\DeclareStringOption[10mm]{sepHablaR}

% Sangría del texto del acotación
\DeclareStringOption[17mm]{sepAcotarL}
\DeclareStringOption[17mm]{sepAcotarR}

% Sangría del texto del nombre del personaje
\DeclareStringOption[25mm]{sepPersonajL}


%-----------------------------
%   Procesar las variables

\ProcessKeyvalOptions*

%-----------------------------
%   Variables para entorno

\newif\ifinsideverso
\insideversofalse

\newif\ifprimercotar
\primercotarfalse

%-----------------------------------------------------------
%    Longitudes internas
%-----------------------------------------------------------

\RequirePackage{etoolbox}
% forcsvlist es parte de etoolbox

\newcommand{\newlengths}[1]{%
  \forcsvlist{\newlength}{#1}%
}

\newlengths{\hablaLskip,\hablaRskip,\acotarLskip,\acotarRskip,\personajLskip,
\parlasep,\parlaParsep,\parlaVersep}

\setlength{\hablaLskip}{\dimexpr\pilarteatro@sepHablaL\relax}
\setlength{\hablaRskip}{\dimexpr\pilarteatro@sepHablaR\relax}
\setlength{\acotarLskip}{\dimexpr\pilarteatro@sepAcotarL\relax}
\setlength{\acotarRskip}{\dimexpr\pilarteatro@sepAcotarR\relax}
\setlength{\personajLskip}{\dimexpr\pilarteatro@sepPersonajL\relax}
\setlength{\parlasep}{6pt}
\setlength{\parlaParsep}{6pt}
\setlength{\parlaVersep}{0pt}

%-----------------------------------------------------------
%    Paquetes requeridos
%-----------------------------------------------------------

\RequirePackage{needspace}

%-----------------------------------------------------------
%    Macros para teatro
%-----------------------------------------------------------

%------------------------------------------------
%   Acotaciones

\newenvironment{acotado}{
	\begin{rmfamily}\begin{itshape}
		}{
	\end{itshape}\end{rmfamily}
}

\newcommand{\acotar}[1]{
	\ifprimercotar
		% nada
	\else
		\vspace{\parlaVersep/2}
	\fi
	\vspace{-\parlaParsep/2}
	\begingroup
		\leftskip=\acotarLskip
		\rightskip=\acotarRskip
		(\textit{#1})
		\par
	\endgroup
	\vspace{-\parlaParsep/2}
	\vspace{\parlaVersep/2}
}


%------------------------------------------------
%	Parlamentos

\newenvironment{habla}{
		\begingroup
			\setlength{\parskip}{\parlaParsep}
			\leftskip=\hablaLskip
			\rightskip=\hablaRskip
	}{
			\par
		\endgroup
	}

\newenvironment{parla}[2][]{
	\def\acotacion{#1}%
	\ifx\acotacion\empty%
	  \Needspace{2\baselineskip}%
	\else%
	  \Needspace{3\baselineskip}%
	\fi%
	\vspace{\parlasep/2}
	\begingroup
		\setlength{\parskip}{0pt}
		\begingroup
			\leftskip=\personajLskip
			\noindent \textrm{\textsc{#2}} \par
		\endgroup
		\vspace{-\parlaParsep}
		\begin{habla}
			\ifx\acotacion\empty
  			% vacío
			\else
				\primercotartrue
  			\acotar{#1} \par \vspace{-\parlaParsep/2-\parlaVersep/2}
				\primercotarfalse
			\fi
	}{
		\end{habla}
	\endgroup
	\vspace{\parlasep/2}
}


%------------------------------------------------
%	Utilidades

% Continuación
\newcommand{\cont}{\textbf{\hspace{0.5ex} (cont.)}}

% Resaltar personaje cuando se menciona
\newcommand{\personaje}[1]{\emph{\textsf{#1}}}

% Final de un texto
\newcommand{\fintexto}[1][FIN]{
	\begin{center}
		\vspace{4em}
		{\large \fontfamily{lmss}\selectfont \bfseries #1}
	\end{center}
}

% Linea de puntos
\newcommand{\Dotfill}{
	\vspace{-8pt}
	\dotfill
}

\newcommand{\sep}{
	\vspace{\parlaParsep+\parlaVersep}
}

\newcommand{\pegado}{
	\vspace{-\parlaParsep/2-\parlaVersep/2}
}


%-----------------------------------------------------------
%    Verso y dobles columnas
%-----------------------------------------------------------

%------------------------------------------------
% Multi columnas

\ifpilarteatro@multicol
	% Código para activar modo doble columna

	\RequirePackage{multicol} % Usar varias columnas
	\setlength{\columnsep}{0.6cm} % Separación entre las columnas
\fi


%------------------------------------------------
% Versos y canciones

\ifpilarteatro@verso
	% Código para activar modo verso

	\newcommand{\estrofa}{\vspace{\parlaVersep}}

	\newenvironment{versodo}{
		\insideversotrue
		\begingroup
			\setlength{\parlaVersep}{6pt}
			\setlength{\parlaParsep}{0pt}
	}{
		\endgroup
		\insideversofalse
	}

	\newenvironment{versomio}{
		\begin{flushleft}
			\small
			\setstretch{1.0}
	}{
		\end{flushleft}
	}
\fi


%------------------------------------------------
% Versos con multi columna

\ifpilarteatro@multicol
	\ifpilarteatro@verso

		\newenvironment{versomiodo}{
			\begin{flushleft}
				\begin{multicols}{2}
					\small
					\setstretch{1.0}
		}{
				\end{multicols}
			\end{flushleft}
		}

	\fi
\fi


%-----------------------------------------------------------
%    Indicaciones ténicas
%-----------------------------------------------------------

%\newenvironment{tecnico}{
	%	\vspace{1ex}
	%	\hspace{\fill}
	%	\begin{minipage}{6.5cm}
		%		\setstretch{1.0}
		%		\setlength{\parskip}{6pt} % Espacio entre párrafos
		%		
		%		\begin{flushleft}
			%			\ttfamily
			%			\small
			%}{
			%		\end{flushleft}
		%	\end{minipage}
	%	\hspace{2cm}
	%	\vspace{1ex}
	%}	
