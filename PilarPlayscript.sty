\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{PilarPlayscript}[2025/10/13 Paquete para textos teatrales]

%-----------------------------------------------------------
%    Configuración de variables
%-----------------------------------------------------------

\RequirePackage{kvoptions}

\SetupKeyvalOptions{
	family=pilarteatro,
	prefix=pilarteatro@
}

%-----------------------------
%   Activar opciones

\DeclareBoolOption{verso}
\DeclareBoolOption{multicol}


%-----------------------------
%   Definir longitudes

% Sangría del texto del parlamento
\DeclareStringOption[10mm]{sepLHabla}  % valor por defecto: 10pt
\DeclareStringOption[10mm]{sepRHabla}

% Sangría del texto del acotación
\DeclareStringOption[17mm]{sepLAcotar}
\DeclareStringOption[17mm]{sepRAcotar}

% Sangría del texto del nombre del personaje
\DeclareStringOption[25mm]{sepLPersonaj}


%-----------------------------
%   Procesar las variables

\ProcessKeyvalOptions*

%-----------------------------


\newlength{\sepParrafo} \setlength{\sepParrafo}{6pt}


%-----------------------------------------------------------
%    Macros para teatro
%-----------------------------------------------------------

%------------------------------------------------
%   Acotaciones

\newenvironment{acotado}{
	\begin{rmfamily}\begin{itshape}
		}{
	\end{itshape}\end{rmfamily}
}

\newcommand{\acotar}[1]{
	\begingroup
		\leftskip=\dimexpr\pilarteatro@sepLAcotar\relax
		\rightskip=\dimexpr\pilarteatro@sepRAcotar\relax
		(\textit{#1})
		\par
	\endgroup
	\vspace{-\sepParrafo}
}


%------------------------------------------------
%	Parlamentos

\newenvironment{habla}{
		\vspace{-\sepParrafo}
		\begingroup
			\setlength{\parskip}{\sepParrafo}
			\leftskip=\dimexpr\pilarteatro@sepLHabla\relax
			\rightskip=\dimexpr\pilarteatro@sepRHabla\relax
	}{
			\par
		\endgroup
	}

\newenvironment{parla}[2][]{
	\def\acotacion{#1}%
	\ifx\acotacion\empty%
	  \Needspace{2\baselineskip}%
	\else%
		\Needspace{3\baselineskip}%
	\fi%
	\vspace{\sepParrafo/2}
	\begingroup
		\setlength{\parskip}{0pt}
		\begingroup
			\leftskip=\dimexpr\pilarteatro@sepLPersonaj\relax
			\noindent \textrm{\textsc{#2}} \par
		\endgroup
		\begin{habla}
			\ifx\acotacion\empty
  			% vacío
			\else
				\acotar{#1} \par
			\fi
	}{
		\end{habla}
	\endgroup
	\vspace{\sepParrafo/2}
}


%------------------------------------------------
%	Utilidades

% Continuación
\newcommand{\cont}{\textbf{\hspace{0.5ex} (cont.)}}

% Resaltar personajes
\newcommand{\personaje}[1]{\emph{\textsf{#1}}}

% Final de un texto
\newcommand{\fintexto}[1][FIN]{
	\begin{center}
		\vspace{4em}
		{\large \fontfamily{lmss}\selectfont \bfseries #1}
	\end{center}
}

% Linea de puntos
\newcommand{\Dotfill}{
	\vspace{-8pt}
	\dotfill
}

\newcommand{\sep}{
	\vspace{\sepParrafo}
}

\newcommand{\pegado}{
	\vspace{-4pt}
}


%-----------------------------------------------------------
%    Verso y dobles columnas
%-----------------------------------------------------------

\ifpilarteatro@multicol
	% Código para activar modo doble columna

	\RequirePackage{multicol} % Usar varias columnas
	\setlength{\columnsep}{0.6cm} % Separación entre las columnas
\fi


%------------------------------------------------
% Versos y canciones

\ifpilarteatro@verso
	% Código para activar modo verso

	\global\pilarteatro@multicoltrue

	\newenvironment{versomio}{
		\begin{flushleft}
			\small
			\setstretch{1.0}
	}{
		\end{flushleft}
	}

	\newenvironment{versomiodo}{
		\begin{flushleft}
			\begin{multicols}{2}
				\small
				\setstretch{1.0}
	}{
			\end{multicols}
		\end{flushleft}
	}
\fi



%-----------------------------------------------------------
%    Indicaciones ténicas
%-----------------------------------------------------------

%\newenvironment{tecnico}{
	%	\vspace{1ex}
	%	\hspace{\fill}
	%	\begin{minipage}{6.5cm}
		%		\setstretch{1.0}
		%		\setlength{\parskip}{6pt} % Espacio entre párrafos
		%		
		%		\begin{flushleft}
			%			\ttfamily
			%			\small
			%}{
			%		\end{flushleft}
		%	\end{minipage}
	%	\hspace{2cm}
	%	\vspace{1ex}
	%}	
